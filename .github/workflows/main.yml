name: VPS Temporária com SSH e Speedtest

on: [push]

jobs:
  vps:
    runs-on: ubuntu-latest

    steps:
      - name: Gerar chave SSH
        run: |
          ssh-keygen -t rsa -f ~/.ssh/id_rsa -q -N ""
          cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys

      - name: Mostrar chave privada para Termius
        run: |
          echo "----- INÍCIO DA CHAVE PRIVADA -----"
          cat ~/.ssh/id_rsa
          echo "------ FIM DA CHAVE PRIVADA ------"

      - name: Instalar e iniciar SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server
          sudo service ssh start

      - name: Conectar ao Serveo
        run: |
          ssh -o StrictHostKeyChecking=no -R 0:localhost:22 serveo.net | tee serveo.log &
          sleep 10
          grep "Forwarding TCP" serveo.log

      - name: Instalar e executar Speedtest
        run: |
          sudo apt-get install -y speedtest-cli
          speedtest-cli

      - name: Manter VPS viva por 1 hora
        run: sleep 3600
